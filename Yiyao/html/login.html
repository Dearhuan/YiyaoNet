<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>登录</title>
  <link rel="stylesheet" href="../css/base_px.css">
  <link rel="stylesheet" href="../css/login.css">
  <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
  <script src="../js/captcha.min.js"></script>
  <script src="../js/login.js"></script>
  <script src="../js/Cookie.js"></script>
</head>

<body>
  <div class="wrap head">
    <a href="./index.html" class="logo">
      <img src="https://s.maiyaole.com/images/passport/yao_logo.png" alt="" id="yao_logo">
    </a>
  </div>

  <div class="wrap login_wrap">
    <a class="bg_link" id="2014_login_background_a" target="_blank">&nbsp;</a>
    <div class="tab_box clearfix">
      <div class="item cur" id="commonLoginTab">
        <a href="javascript:switchLoginTab(1);">普通登录</a>
      </div>
      <div class="item" id="quickLoginTab">
        <a href="javascript:switchLoginTab(2);">手机快速登录</a>
      </div>
    </div>
    <div class="tab_con" id="commonLogin" style="display: block">
      <h2 class="lg_title"><span class="fr">还不是1药网会员？<a href="regist.html"
            class="blue_link">免费注册</a></span>Hi，欢迎登录！</h2>
      <form action="" autocomplete="off">
        <div class="reg_row">
          <!-- 用户名 -->
          <input type="text" name="ecuserCustomer.id" id="userName" autocomplete="off" placeholder="邮箱/手机号/用户名"
            class="form-control u_name" tabindex="1">
          <i id="pas_empty" class="i_empty" style="display:none;">不能为空</i>
          <span id="accountDesc" class="error" style="display:none;">请输入正确的用户名</span>
        </div>
        <div class="reg_row">
          <!-- 密码 -->
          <input type="password" id="userPass" name="ecuserCustomer.password" autocomplete="off" placeholder="登录密码"
            class="form-control u_ps" tabindex="2">
          <i id="pwd_empty" class="i_empty" style="display:none;">不能为空</i>
          <span class="fr"><a href="/sso/lost.action" tabindex="-1" target="_blank" class="gray">忘记密码？</a></span>
          <span id="pwd_desc" class="error" style="display:none;">请输入正确的密码</span>
        </div>
        <div id="vcd_div" class="reg_row verify_box">
          <input type="text" maxlength="4" id="vcd" tabindex="3" name="validCode" placeholder="验证码"
            class="form-control u_verify">
          <i id="vcd_empty" class="i_empty" style="display:none;">不能为空</i>
          <i id="vcd_tatus"></i>
          <canvas width="120" height="40" id="captcha"></canvas>
          <span id="vcd_desc" class="error" style="display:none;">请输入正确的验证码</span>
        </div>
        <div class="">
          <!-- 1药网协议-->
          <label class="checkbox"><input type="checkbox" value="1" name="rememberPwd" id="rememberPwd" tabindex="-1">
            <span class="two_week">两周内免登录</span>
          </label>
          <button data-ywpoint="null_null_null_null_I0203_0" type="button" id="btnSubmit"
            class="btn btn-primary">登录</button><br>
          <span id="login_desc" class="error"></span>
        </div>
        <div class="protocal_warm">
          <span class="two_week">登录即代表您已同意1药网
            <a class="blue_link"href="javascript:void(0);">《服务协议》</a>和
            <a class="blue_link"href="javascript:void(0);">《隐私条款》</a>
          </span>
        </div>
        <div class="reg_row hz_login">
          <p>使用合作伙伴账号登录：</p>
          <a class="first a_wx"href="javascript:void(0);">微信</a>
          <a class="a_zfb" href="javascript:void(0);">支付宝</a>
          <a class="a_qq"href="javascript:void(0);">QQ</a>

        </div>
        <div class="moreWebDiv">
          <span class="moreWeb">更多合作网站<button class="moreWebBtn"></button></span>
          <div class="moreTab">
            <a class="first a_yhd" href="javascript:void(0);"></a>
            <a class="a_sina" href="javascript:void(0);"></a>
            <a class="a_wlt" href="javascript:void(0);"></a>
            <a class="last a_wy" href="javascript:void(0);"></a>
          </div>
        </div>
      </form>
    </div>
    <div class="tab_con" id="quickLogin" style="display: none">
      <h2 class="lg_title"><span class="fr">还不是1药网会员？<a href="/sso/register.action"
            class="blue_link">免费注册</a></span>Hi，欢迎登录！</h2>
      <div class="form_group pb35 clearfix">
        <label class="lbs fl">
          <input type="text" class="txt phone" id="phoneNum4QuickLogin" placeholder="请输入您的手机号码" value="">
          <i id="phoneNum4QuickLogin_empty" class="i_empty" style="display:none;">不能为空</i>
          <span id="phoneNum4QuickLoginDesc" class="error" style="display: none">请输入正确的手机号码</span>
        </label>
      </div>
      <div id="vcd_div_sms" class="reg_row pb35 verify_box" style="display: none">
        <input type="text" maxlength="4" id="vcd_sms" tabindex="3" name="validCode" placeholder="验证码"
          class="form-control u_verify">
        <i id="vcd_tatus_sms"></i>
        <canvas width="120" height="40" id="captcha"></canvas>
        <span id="vcd_desc_sms" class="error" style="display: none">请输入正确的验证码</span>
      </div>

      <div class="form_group pb35 clearfix">
        <label class="lbs fl mr10">
          <input type="text" class="txt check_num" id="smsCode4QuickLogin" placeholder="请输入短信验证码" value="">
          <span id="smsCode4QuickLoginDesc" class="error" style="display: none">请输入正确的验证码</span>
        </label>
        <label class="lbs fl ">
          <button type="button" id="getSmsCodeBtn" class="check_btn"
            style="cursor: pointer;display: block;">获取短信验证码</button>
          <button type="button" id="SmsCodeInfoBtn" class="check_btn" style="cursor: pointer;display: none"></button>
        </label>
      </div>

      <div data-ywpoint="null_null_null_null_I0204_0" class="ilogin">
        <!-- 1药网协议-->
        <button type="button" id="btnSubmit4QuickLogin" class="btn btn-primary">登录</button><br>
        <span id="quickLogin_desc" class="error"></span>
      </div>
      <div class="protocal_warm">
        <span class="two_week">登录即代表您已同意1药网
          <a class="blue_link" href="javascript:void(0);">《服务协议》</a>和
          <a class="blue_link" href="javascript:void(0);">《隐私条款》</a>
        </span>
      </div>
      <div class="reg_row hz_login">
        <p>使用合作伙伴账号登录：</p>
        <a class="first a_wx" href="javascript:void(0);">微信</a>
        <a class="a_zfb" href="javascript:void(0);">支付宝</a>
        <a class="a_qq"  href="javascript:void(0);">QQ</a>

      </div>
      <div class="moreWebDiv">
        <span class="moreWeb">更多合作网站<button class="moreWebBtn"></button></span>
        <div class="moreTab">
          <a class="first a_yhd" href="javascript:void(0);"></a>
          <a class="a_sina" href="javascript:void(0);"></a>
          <a class="a_wlt" 
            href="javascript:void(0);"></a>
          <a class="last a_wy" href="javascript:void(0);"></a>
        </div>
      </div>

    </div>
  </div>

  <div class="common_footer_simple">
    <div class="bottom_link">
      <p><a href="//gangling.111.com.cn" rel="nofollow">关于111集团</a>|<a href="//www.111.com.cn/cmsPage/2015012602/"
          rel="nofollow">关于1药网</a>|<a href="//mall.yaoex.com" rel="nofollow">关于1药城</a>|<a href="http://ir.111.com.cn/"
          rel="nofollow">Investor Relations</a>|<a href="//www.111.com.cn/cmsPage/2015012707/"
          rel="nofollow">诚聘英才</a>|<a href="//www.111.com.cn/cmsPage/2014022401/index.html" rel="nofollow">直营实体药房</a></p>
      <p><a href="//www.111.com.cn/cmsPage/2013101401/" rel="nofollow">互联网药品信息服务资格证</a>|<a
          href="//www.111.com.cn/cmsPage/2013101402/" rel="nofollow">互联网药品交易资格证：粤C20150007</a>|<a
          href="//www.111.com.cn/cmsPage/2014041703/" rel="nofollow">连锁营业执照</a>|<a
          href="//www.111.com.cn/cmsPage/2013101405/" rel="nofollow">药品营业许可证</a>|<a
          href="//www.111.com.cn/cmsPage/2013101407/" rel="nofollow">医疗器械许可证</a>|<a
          href="//www.111.com.cn/cmsPage/2013101404/" rel="nofollow">食品经营许可证</a>|<a
          href="//www.111.com.cn/cmsPage/2013101408/" rel="nofollow">GSP证书</a>|<a
          href="//www.111.com.cn/cmsPage/2015032501/" rel="nofollow">ICP粤B2-20150066</a></p>
    </div>
    <div class="copy_info">
      <p>1药网网上药店，国家药监局认证通过的合法网上药店，中国医药电子商务行业的开拓者领跑者。<a href="http://www.beian.miit.gov.cn"
          style="color:#999">粤ICP备12015869号-1</a>
        <!--<br/>公司名称：广东壹号大药房连锁有限公司 公司地址：广东省广州市越秀区共和西路1号2层 联系电话：020-31067218-->
      </p>
      <p><span>Copyright(C)2010-2015 1药网版权所有</span><span><a
            href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010402000743" class="copy_ico"
            rel="nofollow"></a><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44010402000743"
            style="color:#999" rel="nofollow">公安备案号 440104020000743</a></span></p>
    </div>
  </div>

  <script>
    let usernameInput = $('#userName');
    let passwordInput = $('#userPass');
    let imageCodeInput = $('#vcd');
    let phoneInput = $('#phoneNum4QuickLogin');
    let msgCodeInput = $('#smsCode4QuickLogin');

    let msgCodeBtn = $('#getSmsCodeBtn');
    let msgInfoBtn = $('#SmsCodeInfoBtn');
    let loginBtn = $('#btnSubmit');
    let quickLogin = $('#btnSubmit4QuickLogin');

    let usernameVal = "";
    let passwordVal = "";
    let phoneVal = "";
    let imageCodeVal = "";
    let msgCodeVal = "";
    let num;

    let usernameReg = /^[a-zA-Z]{6,8}$/; /* 请设置您的用户名(6~8位字母区分大小写) */
    let phoneReg = /^1[3-9]\d{9}$/; /* 第一位：1 第二位不能为012 11位数字 */
    let passwordReg = /^[a-zA-Z0-9]{6,16}$/;

    (new Captcha({ //画出验证码
      lineNum: 5,
      dotNum: 10,
      length: 4,
      fontSize: 30
    })).draw(document.querySelector('#captcha'), r => {
      console.log(r, '验证++++');
      imageCodeVal = r;
    });

    $('#getSmsCodeBtn').click(function () { //获取短信验证码
      phoneInput.trigger('blur');
      let flag = phoneInput.hasClass('error');
      if (flag) {
        alert('手机号码不正确！请重新输入');
        return;
      } else {
        let timeCount = 60;
        msgCodeBtn.stop().hide();
        msgInfoBtn.stop().show();
        let timer = setInterval(function () {
          timeCount--;
          msgInfoBtn.text(`${timeCount}秒`);
          if (timeCount == 0) {
            clearInterval(timer);
            msgCodeBtn.stop().show();
            msgInfoBtn.stop().hide();
            msgCodeBtn.text('获取短信验证码');
          }
        }, 1000);

        //获取随机数
        function getRandNum(min, max) {
          return parseInt(Math.random() * (max - min + 1) + min);
        }

        function formatterDateTime() {
          var date = new Date()
          var month = date.getMonth() + 1
          var datetime = date.getFullYear() +
            "" // "年"
            +
            (month >= 10 ? month : "0" + month) +
            "" // "月"
            +
            (date.getDate() < 10 ? "0" + date.getDate() : date
              .getDate()) +
            "" +
            (date.getHours() < 10 ? "0" + date.getHours() : date
              .getHours()) +
            "" +
            (date.getMinutes() < 10 ? "0" + date.getMinutes() : date
              .getMinutes()) +
            "" +
            (date.getSeconds() < 10 ? "0" + date.getSeconds() : date
              .getSeconds());
          return datetime;
        }

        num = getRandNum(1000, 9999); //生成四位随机验证码
        console.log(num);
        // msgCodeVal = num;   //存短信验证码
        $.ajax({
          type: 'post',
          url: 'http://route.showapi.com/28-1',
          dataType: 'json',
          data: {
            "showapi_timestamp": formatterDateTime(),
            "showapi_appid": '105009', //这里需要改成自己的appid
            "showapi_sign": '51084e3ee1f34d5c86af6e0e3506a8fa', //这里需要改成自己的应用的密钥secret
            "mobile": phoneInput.val().trim(),
            "content": `{\"name\":\"牛二\",\"code\":\"${num}\",\"minute\":\"3\",\"comName\":\"千峰教育\"}`,
            "tNum": "T150606060601",
            "big_msg": ""
          },
          error: function (XmlHttpRequest, textStatus, errorThrown) {
            alert("操作失败!");
          },
          success: function (result) {
            console.log(result) //console变量在ie低版本下不能用
            // alert(result.showapi_res_code);
            alert('发送成功');
          }
        });
      }
    })

    phoneInput.blur(function () { //手机号校验
      let val = $(this).val().trim();
      if (val.length == 0) {
        $(this).siblings('.i_empty').css('display', 'block');
        $(this).siblings('span').css('display', 'block');
        $(this).addClass('ierror');
      } else {
        if (!phoneReg.test(val)) {
          $(this).siblings('.i_empty').css('display', 'none');
          $(this).siblings('span').css('display', 'block');
          $(this).addClass('ierror');

        } else {
          $(this).siblings('.i_empty').css('display', 'none');
          $(this).siblings('span').css('display', 'none');
          $(this).removeClass('ierror');

          phoneVal = val;
        }
      }
    });

    msgCodeInput.blur(function () { //短信验证码校验
      let val = $(this).val().trim();
      if (val.length == 0) {
        $(this).siblings('.i_empty').css('display', 'block');
        $(this).siblings('span').css('display', 'block');
        $(this).addClass('ierror');

      } else {
        if (val != num) {
          $(this).siblings('.i_empty').css('display', 'none');
          $(this).siblings('span').css('display', 'block');
          $(this).addClass('ierror');

        } else {
          $(this).siblings('.i_empty').css('display', 'none');
          $(this).siblings('span').css('display', 'none');
          $(this).removeClass('ierror');

          msgCodeVal = val;
        }
      }
    });

    usernameInput.blur(function () {
      let val = $(this).val().trim();
      if (val.length == 0) {
        $(this).siblings('.i_empty').css('display', 'block');
        $(this).siblings('.error').css('display', 'block');
        $(this).addClass('ierror');
      } else {
        $(this).siblings('.i_empty').css('display', 'none');
        $(this).siblings('.error').css('display', 'none');
        $(this).removeClass('ierror');
        usernameVal = val;
      }
    })
    passwordInput.blur(function () {
      let val = $(this).val().trim();
      if (val.length == 0) {
        $(this).siblings('.i_empty').css('display', 'block');
        $(this).siblings('.error').css('display', 'block');
        $(this).addClass('ierror');
      } else {
        if (!passwordReg.test(val)) {
          $(this).siblings('.i_empty').css('display', 'none');
          $(this).siblings('.error').css('display', 'block');
          $(this).addClass('ierror');
        } else {
          $(this).siblings('.i_empty').css('display', 'none');
          $(this).siblings('.error').css('display', 'none');
          $(this).removeClass('ierror');
          passwordVal = val;
        }
      };
    })

    imageCodeInput.blur(function () {
      let val = $(this).val().trim();
      val = val.toLowerCase();
      imageCodeVal = imageCodeVal.toLowerCase();
      if (val.length == 0) {
        // $(this).siblings('.i_empty').css('display', 'block');
        $(this).siblings('.error').css('display', 'block');
        $(this).addClass('ierror');

      } else {
        if (val != imageCodeVal) {
          // $(this).siblings('.i_empty').css('display', 'none');
          $(this).siblings('.error').css('display', 'block');
          $(this).addClass('ierror');

        } else {
          // $(this).siblings('.i_empty').css('display', 'none');
          $(this).siblings('span').css('display', 'none');
          $(this).removeClass('ierror');

          imageCodeVal = val;
        }
      }
    })

    

    loginBtn.click(function () {
      console.log(usernameVal, passwordVal);
      let len = $('.ierror').length;
      console.log(len);
      let isSuccess = len == 0 && usernameVal && passwordVal;
      console.log(isSuccess);
      if (!isSuccess) {
        alert('请完善信息！');
        return;
      } else {
        $.ajax({
          type: "post",
          url: "../api/login.php",
          data: `username=${usernameVal}&password=${passwordVal}`,
          dataType: "json",
          success: function (response) {
            if (response.status == "success") {
              // alert(response.data.msg);
              Cookie.set('username',usernameVal,'/',1);
              Cookie.set('password',passwordVal,'/',1);
              window.location.href = "./index.html";
            } else {
              alert(response.data.msg);
            }
          }
        });
      }
    })

    quickLogin.click(function () {
      console.log(phoneVal, msgCodeVal);
      let len = $('.ierror').length;
      console.log(len);

      let isSuccess =
        len == 0 && phoneVal && msgCodeVal;
      console.log(isSuccess);
      if (!isSuccess) {
        alert('请完善信息!');
        return;
      } else {
        console.log('---ok----');
        $.ajax({
          type: "post",
          url: "../api/loginByPhone.php",
          data: `phone=${phoneVal}`,
          dataType: "json",
          success: function (response) {
            if (response.status == "success") {
              // alert(response.data.msg);
              Cookie.set('phone',phoneVal,'/',1);
              window.location.href = "./index.html";
            } else {
              alert(response.data.msg);
            }

          }
        });
      }
    })
  </script>
</body>

</html>